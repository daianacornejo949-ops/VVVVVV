<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario - Bater√≠as Auto</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab-button.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }

        .tab-button:hover {
            background: #fafafa;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row.three {
            grid-template-columns: 1fr 1fr 1fr;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .btn-delete {
            background: #e74c3c;
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .btn-delete:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-compra {
            background: #27ae60;
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .btn-compra:hover {
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
        }

        .card-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .card-value {
            font-size: 1.8em;
            color: #667eea;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .deuda-info {
            background: #fff3cd;
            padding: 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-weight: 600;
            color: #856404;
        }

        .estado-pagado {
            background: #d4edda;
            color: #155724;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .estado-deuda {
            background: #f8d7da;
            color: #721c24;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .empty-message {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        .batch-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîã Sistema de Inventario - Bater√≠as para Autos</h1>
            <p>Gesti√≥n de inventario y facturaci√≥n</p>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="cambiarTab('inventario')">üì¶ Inventario</button>
            <button class="tab-button" onclick="cambiarTab('ventas')">üõí Ventas</button>
            <button class="tab-button" onclick="cambiarTab('registro-ventas')">üìã Registro de Ventas</button>
            <button class="tab-button" onclick="cambiarTab('deudores')">üí∞ Deudores</button>
        </div>

        <!-- TAB INVENTARIO -->
        <div id="inventario" class="tab-content active">
            <h2>Gesti√≥n de Inventario</h2>
            <div id="alertaInventario"></div>

            <div class="stats-grid" style="margin-top: 20px;">
                <div class="card">
                    <div class="card-title">Total de Productos</div>
                    <div class="card-value" id="totalProductos">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Total de Unidades</div>
                    <div class="card-value" id="totalUnidades">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Valor Total Inventario</div>
                    <div class="card-value" id="valorTotal">$0</div>
                </div>
                <div class="card">
                    <div class="card-title">Total Dinero Recibido</div>
                    <div class="card-value" id="dineroRecibido">$0</div>
                </div>
            </div>

            <div style="background: #f5f5f5; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px;">Agregar Nuevo Producto</h3>
                
                <div class="form-row three">
                    <div class="form-group">
                        <label>Marca</label>
                        <input type="text" id="marca" placeholder="Ej: Bosch, Moura, Heliar">
                    </div>
                    <div class="form-group">
                        <label>Tipo de Veh√≠culo</label>
                        <select id="tipoVehiculo">
                            <option value="">Seleccionar...</option>
                            <option value="Auto">Auto</option>
                            <option value="Cami√≥n">Cami√≥n</option>
                            <option value="Moto">Moto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Modelo</label>
                        <input type="text" id="modelo" placeholder="Ej: 200A, 500A">
                    </div>
                </div>

                <div class="form-row three">
                    <div class="form-group">
                        <label>Amperios</label>
                        <input type="number" id="amperios" placeholder="Ej: 60, 80, 100">
                    </div>
                    <div class="form-group">
                        <label>Cantidad en Stock</label>
                        <input type="number" id="cantidad" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Precio Unitario ($)</label>
                        <input type="number" id="precio" placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label style="visibility: hidden;">.</label>
                        <button onclick="agregarProducto()">Agregar Producto</button>
                    </div>
                </div>
            </div>

            <h3>Productos en Inventario</h3>
            <div id="tablaInventario"></div>
        </div>

        <!-- TAB VENTAS -->
        <div id="ventas" class="tab-content">
            <h2>Nueva Venta / Factura</h2>
            <div id="alertaVentas"></div>

            <div style="background: #f5f5f5; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px;">Datos del Cliente</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre del Cliente</label>
                        <input type="text" id="nombreCliente" placeholder="Nombre completo">
                    </div>
                    <div class="form-group">
                        <label>Estado de Pago</label>
                        <select id="estadoPago">
                            <option value="pagado">Pagado</option>
                            <option value="deuda">A Cr√©dito (Deuda)</option>
                        </select>
                    </div>
                </div>

                <h3 style="margin-top: 25px; margin-bottom: 20px;">Seleccionar Producto</h3>

                <div class="form-row three">
                    <div class="form-group">
                        <label>Producto</label>
                        <select id="productoVenta">
                            <option value="">Seleccionar producto...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cantidad a Vender</label>
                        <input type="number" id="cantidadVenta" placeholder="0" min="1">
                    </div>
                    <div class="form-group">
                        <label style="visibility: hidden;">.</label>
                        <button onclick="agregarAlCarrito()">Agregar al Carrito</button>
                    </div>
                </div>
            </div>

            <h3>Carrito de Compra</h3>
            <div id="carritoVenta"></div>

            <div style="margin-top: 30px; text-align: right;">
                <div class="card" style="max-width: 400px; margin-left: auto;">
                    <div class="card-title">Total de la Venta</div>
                    <div class="card-value" id="totalCarrito">$0.00</div>
                </div>
                <button onclick="completarVenta()" style="margin-top: 20px; font-size: 1.2em; padding: 15px 40px;">‚úì Completar Venta</button>
                <button onclick="limpiarCarrito()" style="margin-top: 10px; background: #95a5a6; font-size: 1.2em; padding: 15px 40px;">üóëÔ∏è Limpiar</button>
            </div>
        </div>

        <!-- TAB REGISTRO DE VENTAS -->
        <div id="registro-ventas" class="tab-content">
            <h2>Registro de Ventas</h2>
            <div class="batch-actions">
                <button onclick="exportarVentas()" style="background: #3498db;">üì• Descargar Excel</button>
                <button onclick="limpiarVentas()" style="background: #e74c3c;">üóëÔ∏è Limpiar Todas las Ventas</button>
            </div>
            <div id="listaVentas"></div>
        </div>

        <!-- TAB DEUDORES -->
        <div id="deudores" class="tab-content">
            <h2>Gesti√≥n de Deudores</h2>
            <div id="listaDeudores"></div>
        </div>
    </div>

    <script>
        // INICIALIZAR STORAGE
        function inicializarStorage() {
            if (!localStorage.getItem('inventario')) {
                localStorage.setItem('inventario', JSON.stringify([]));
            }
            if (!localStorage.getItem('ventas')) {
                localStorage.setItem('ventas', JSON.stringify([]));
            }
        }

        // OBTENER DATOS
        function obtenerInventario() {
            return JSON.parse(localStorage.getItem('inventario') || '[]');
        }

        function obtenerVentas() {
            return JSON.parse(localStorage.getItem('ventas') || '[]');
        }

        function guardarInventario(datos) {
            localStorage.setItem('inventario', JSON.stringify(datos));
        }

        function guardarVentas(datos) {
            localStorage.setItem('ventas', JSON.stringify(datos));
        }

        function obtenerAbonos() {
            return JSON.parse(localStorage.getItem('abonos') || '{}');
        }

        function guardarAbonos(datos) {
            localStorage.setItem('abonos', JSON.stringify(datos));
        }

        // CARRITO TEMPORAL
        let carrito = [];

        // CAMBIAR PESTA√ëA
        function cambiarTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Mostrar pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Actualizar vistas seg√∫n pesta√±a
            if (tabName === 'inventario') actualizarInventario();
            if (tabName === 'registro-ventas') actualizarRegistroVentas();
            if (tabName === 'deudores') actualizarDeudores();
            if (tabName === 'ventas') actualizarSelectProductos();
        }

        // AGREGAR PRODUCTO AL INVENTARIO
        function agregarProducto() {
            const marca = document.getElementById('marca').value;
            const tipo = document.getElementById('tipoVehiculo').value;
            const modelo = document.getElementById('modelo').value;
            const amperios = document.getElementById('amperios').value;
            const cantidad = parseInt(document.getElementById('cantidad').value);
            const precio = parseFloat(document.getElementById('precio').value);

            if (!marca || !tipo || !modelo || !amperios || !cantidad || !precio) {
                mostrarAlerta('alertaInventario', 'Completa todos los campos', 'error');
                return;
            }

            const inventario = obtenerInventario();
            const id = Date.now();

            inventario.push({
                id,
                marca,
                tipo,
                modelo,
                amperios: parseInt(amperios),
                cantidad,
                precio,
                fecha: new Date().toLocaleDateString('es-AR')
            });

            guardarInventario(inventario);
            limpiarFormulario();
            actualizarInventario();
            mostrarAlerta('alertaInventario', '‚úì Producto agregado exitosamente', 'success');
        }

        // ACTUALIZAR VISTA DE INVENTARIO
        function actualizarInventario() {
            const inventario = obtenerInventario();
            let html = '';

            if (inventario.length === 0) {
                html = '<div class="empty-message">No hay productos en el inventario</div>';
            } else {
                // Agrupar por marca
                const porMarca = {};
                inventario.forEach(prod => {
                    if (!porMarca[prod.marca]) {
                        porMarca[prod.marca] = [];
                    }
                    porMarca[prod.marca].push(prod);
                });

                // Mostrar por marca
                Object.entries(porMarca).forEach(([marca, productos]) => {
                    html += `<div style="margin-bottom: 30px; padding: 20px; background: #f5f5f5; border-radius: 10px; border-left: 5px solid #667eea;">`;
                    html += `<h3 style="margin-bottom: 15px; color: #333;">üè¢ ${marca}</h3>`;
                    html += '<table><thead><tr><th>Tipo</th><th>Modelo</th><th>Amperios</th><th>Cantidad</th><th>Precio Unitario</th><th>Subtotal</th><th>Acci√≥n</th></tr></thead><tbody>';
                    
                    productos.forEach(prod => {
                        const subtotal = (prod.cantidad * prod.precio).toFixed(2);
                        html += `
                            <tr>
                                <td>${prod.tipo}</td>
                                <td>${prod.modelo}</td>
                                <td>${prod.amperios}A</td>
                                <td><strong>${prod.cantidad}</strong></td>
                                <td>$${prod.precio.toFixed(2)}</td>
                                <td>$${subtotal}</td>
                                <td><button class="btn-delete" onclick="eliminarProducto(${prod.id})">Eliminar</button></td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    html += '</div>';
                });
            }

            document.getElementById('tablaInventario').innerHTML = html;
            actualizarEstadisticas();
        }

        // ACTUALIZAR ESTAD√çSTICAS
        function actualizarEstadisticas() {
            const inventario = obtenerInventario();
            const ventas = obtenerVentas();
            
            let totalProductos = inventario.length;
            let totalUnidades = inventario.reduce((sum, p) => sum + p.cantidad, 0);
            let valorTotal = inventario.reduce((sum, p) => sum + (p.cantidad * p.precio), 0);
            
            // Dinero recibido solo de ventas pagadas
            let dineroRecibido = ventas
                .filter(v => v.estado === 'pagado')
                .reduce((sum, v) => sum + v.total, 0);

            document.getElementById('totalProductos').textContent = totalProductos;
            document.getElementById('totalUnidades').textContent = totalUnidades;
            document.getElementById('valorTotal').textContent = '$' + valorTotal.toFixed(2);
            document.getElementById('dineroRecibido').textContent = '$' + dineroRecibido.toFixed(2);
        }

        // ELIMINAR PRODUCTO
        function eliminarProducto(id) {
            if (confirm('¬øEst√°s seguro de eliminar este producto?')) {
                let inventario = obtenerInventario();
                inventario = inventario.filter(p => p.id !== id);
                guardarInventario(inventario);
                actualizarInventario();
                mostrarAlerta('alertaInventario', '‚úì Producto eliminado', 'success');
            }
        }

        // ACTUALIZAR SELECT DE PRODUCTOS EN VENTAS
        function actualizarSelectProductos() {
            const inventario = obtenerInventario();
            let html = '<option value="">Seleccionar producto...</option>';

            // Agrupar por marca
            const porMarca = {};
            inventario.forEach(prod => {
                if (prod.cantidad > 0) {
                    if (!porMarca[prod.marca]) {
                        porMarca[prod.marca] = [];
                    }
                    porMarca[prod.marca].push(prod);
                }
            });

            // Mostrar opciones agrupadas por marca
            Object.entries(porMarca).forEach(([marca, productos]) => {
                html += `<optgroup label="--- ${marca} ---">`;
                productos.forEach(prod => {
                    html += `<option value="${prod.id}" data-precio="${prod.precio}" data-cantidad="${prod.cantidad}">
                        ${prod.tipo} - ${prod.modelo} (${prod.amperios}A) - ${prod.cantidad} disp.
                    </option>`;
                });
                html += `</optgroup>`;
            });

            document.getElementById('productoVenta').innerHTML = html;
        }

        // AGREGAR AL CARRITO
        function agregarAlCarrito() {
            const select = document.getElementById('productoVenta');
            const productId = select.value;
            const cantidad = parseInt(document.getElementById('cantidadVenta').value);

            if (!productId) {
                mostrarAlerta('alertaVentas', 'Selecciona un producto', 'error');
                return;
            }

            if (!cantidad || cantidad <= 0) {
                mostrarAlerta('alertaVentas', 'Ingresa una cantidad v√°lida', 'error');
                return;
            }

            const inventario = obtenerInventario();
            const producto = inventario.find(p => p.id == productId);

            if (!producto) {
                mostrarAlerta('alertaVentas', 'Producto no encontrado', 'error');
                return;
            }

            if (cantidad > producto.cantidad) {
                mostrarAlerta('alertaVentas', `No hay suficiente stock. Disponible: ${producto.cantidad}`, 'error');
                return;
            }

            // Agregar o actualizar en carrito
            const itemCarrito = carrito.find(item => item.id == productId);
            if (itemCarrito) {
                if (itemCarrito.cantidadVenta + cantidad > producto.cantidad) {
                    mostrarAlerta('alertaVentas', `No hay suficiente stock`, 'error');
                    return;
                }
                itemCarrito.cantidadVenta += cantidad;
            } else {
                carrito.push({
                    id: producto.id,
                    marca: producto.marca,
                    tipo: producto.tipo,
                    modelo: producto.modelo,
                    amperios: producto.amperios,
                    precio: producto.precio,
                    cantidadVenta: cantidad
                });
            }

            document.getElementById('cantidadVenta').value = '';
            actualizarVistaCarrito();
            mostrarAlerta('alertaVentas', '‚úì Producto agregado al carrito', 'success');
        }

        // ACTUALIZAR VISTA DEL CARRITO
        function actualizarVistaCarrito() {
            let html = '';
            let total = 0;

            if (carrito.length === 0) {
                html = '<div class="empty-message">Carrito vac√≠o</div>';
            } else {
                html += '<table><thead><tr><th>Producto</th><th>Cantidad</th><th>Precio Unit.</th><th>Subtotal</th><th>Acci√≥n</th></tr></thead><tbody>';

                carrito.forEach((item, index) => {
                    const subtotal = item.cantidadVenta * item.precio;
                    total += subtotal;
                    html += `
                        <tr>
                            <td><strong>${item.marca}</strong><br>${item.tipo} - ${item.modelo} (${item.amperios}A)</td>
                            <td>${item.cantidadVenta}</td>
                            <td>$${item.precio.toFixed(2)}</td>
                            <td>$${subtotal.toFixed(2)}</td>
                            <td><button class="btn-delete" onclick="eliminarDelCarrito(${index})">Quitar</button></td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
            }

            document.getElementById('carritoVenta').innerHTML = html;
            document.getElementById('totalCarrito').textContent = '$' + total.toFixed(2);
        }

        // ELIMINAR DEL CARRITO
        function eliminarDelCarrito(index) {
            carrito.splice(index, 1);
            actualizarVistaCarrito();
        }

        // COMPLETAR VENTA
        function completarVenta() {
            const nombreCliente = document.getElementById('nombreCliente').value;
            const estadoPago = document.getElementById('estadoPago').value;

            if (!nombreCliente) {
                mostrarAlerta('alertaVentas', 'Ingresa el nombre del cliente', 'error');
                return;
            }

            if (carrito.length === 0) {
                mostrarAlerta('alertaVentas', 'El carrito est√° vac√≠o', 'error');
                return;
            }

            // Registrar venta
            const venta = {
                id: Date.now(),
                fecha: new Date().toLocaleDateString('es-AR'),
                hora: new Date().toLocaleTimeString('es-AR'),
                cliente: nombreCliente,
                items: [...carrito],
                total: carrito.reduce((sum, item) => sum + (item.cantidadVenta * item.precio), 0),
                estado: estadoPago
            };

            // Guardar venta
            const ventas = obtenerVentas();
            ventas.push(venta);
            guardarVentas(ventas);

            // Actualizar inventario
            let inventario = obtenerInventario();
            carrito.forEach(item => {
                const prod = inventario.find(p => p.id == item.id);
                if (prod) {
                    prod.cantidad -= item.cantidadVenta;
                }
            });
            guardarInventario(inventario);

            // Limpiar
            limpiarCarrito();
            document.getElementById('nombreCliente').value = '';
            document.getElementById('estadoPago').value = 'pagado';
            
            mostrarAlerta('alertaVentas', '‚úì Venta registrada exitosamente', 'success');
            actualizarSelectProductos();
        }

        // LIMPIAR CARRITO
        function limpiarCarrito() {
            carrito = [];
            actualizarVistaCarrito();
        }

        // ACTUALIZAR REGISTRO DE VENTAS
        function actualizarRegistroVentas() {
            const ventas = obtenerVentas();
            let html = '';

            if (ventas.length === 0) {
                html = '<div class="empty-message">No hay ventas registradas</div>';
            } else {
                html += '<table><thead><tr><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Productos</th><th>Total</th><th>Dinero Pagado</th><th>Estado</th><th>Acci√≥n</th></tr></thead><tbody>';

                ventas.forEach(venta => {
                    const productosText = venta.items.map(item => 
                        `<strong>${item.marca}</strong> - ${item.tipo} ${item.modelo} (${item.cantidadVenta} x $${item.precio.toFixed(2)})`
                    ).join('<br>');
                    
                    const estadoClass = venta.estado === 'pagado' ? 'estado-pagado' : 'estado-deuda';
                    const estadoText = venta.estado === 'pagado' ? 'PAGADO' : 'DEUDA';
                    const dineroPagado = venta.estado === 'pagado' ? `$${venta.total.toFixed(2)}` : '---';

                    html += `
                        <tr>
                            <td>${venta.fecha}</td>
                            <td>${venta.hora}</td>
                            <td><strong>${venta.cliente}</strong></td>
                            <td>${productosText}</td>
                            <td><strong>$${venta.total.toFixed(2)}</strong></td>
                            <td><strong style="color: #27ae60;">${dineroPagado}</strong></td>
                            <td><span class="${estadoClass}">${estadoText}</span></td>
                            <td><button class="btn-delete" onclick="eliminarVenta(${venta.id})">Eliminar</button></td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
            }

            document.getElementById('listaVentas').innerHTML = html;
        }

        // ELIMINAR VENTA
        function eliminarVenta(id) {
            if (confirm('¬øEst√°s seguro? Esto no se puede deshacer.')) {
                let ventas = obtenerVentas();
                ventas = ventas.filter(v => v.id !== id);
                guardarVentas(ventas);
                actualizarRegistroVentas();
                mostrarAlerta('alertaVentas', '‚úì Venta eliminada', 'success');
            }
        }

        // ACTUALIZAR DEUDORES
        function actualizarDeudores() {
            const ventas = obtenerVentas();
            const abonos = obtenerAbonos();
            const deudores = {};

            ventas.forEach(venta => {
                if (venta.estado === 'deuda') {
                    if (!deudores[venta.cliente]) {
                        deudores[venta.cliente] = {
                            ventasCliente: [],
                            totalDeuda: 0,
                            abonos: 0
                        };
                    }
                    deudores[venta.cliente].ventasCliente.push(venta);
                    deudores[venta.cliente].totalDeuda += venta.total;
                }
            });

            // Agregar abonos registrados
            Object.entries(abonos).forEach(([cliente, monto]) => {
                if (deudores[cliente]) {
                    deudores[cliente].abonos = monto;
                }
            });

            let html = '';

            if (Object.keys(deudores).length === 0) {
                html = '<div class="empty-message">No hay deudores</div>';
            } else {
                html += '<div>';
                Object.entries(deudores).forEach(([cliente, datos]) => {
                    const totalDeuda = datos.totalDeuda;
                    const abonos = datos.abonos || 0;
                    const deudaPendiente = totalDeuda - abonos;
                    const porcentajePagado = ((abonos / totalDeuda) * 100).toFixed(1);
                    
                    let ventasHtml = '<ul>';
                    datos.ventasCliente.forEach(venta => {
                        ventasHtml += `<li>${venta.fecha} - $${venta.total.toFixed(2)}</li>`;
                    });
                    ventasHtml += '</ul>';

                    let colorDeuda = '#e74c3c';
                    if (deudaPendiente <= 0) {
                        colorDeuda = '#27ae60';
                    } else if (porcentajePagado > 50) {
                        colorDeuda = '#f39c12';
                    }

                    html += `
                        <div class="card">
                            <div class="card-title">üë§ ${cliente}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #e74c3c;">
                                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Deuda Total</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: #333;">$${totalDeuda.toFixed(2)}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #27ae60;">
                                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Abonado</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: #27ae60;">$${abonos.toFixed(2)}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid ${colorDeuda};">
                                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Pendiente</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: ${colorDeuda};">$${deudaPendiente.toFixed(2)}</div>
                                </div>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <div style="width: 100%; height: 8px; background: #ddd; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                                    <div style="width: ${Math.min(porcentajePagado, 100)}%; height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71);"></div>
                                </div>
                                <div style="text-align: center; font-size: 0.9em; color: #666;">
                                    ${porcentajePagado}% pagado
                                </div>
                            </div>

                            <div>
                                <strong>Detalle de Compras:</strong>
                                ${ventasHtml}
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em;">Registrar Abono ($)</label>
                                    <div style="display: flex; gap: 8px;">
                                        <input type="number" id="abono_${cliente}" placeholder="0.00" step="0.01" min="0" style="flex: 1;">
                                        <button onclick="registrarAbono('${cliente}')" class="btn-compra" style="padding: 8px 15px;">
                                            ‚úì Abonar
                                        </button>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    ${deudaPendiente <= 0 ? 
                                        `<button onclick="marcarComoPagado('${cliente}')" class="btn-compra" style="width: 100%; margin-top: 30px;">‚úì Marcar Totalmente Pagado</button>` : 
                                        `<button onclick="limpiarAbono('${cliente}')" style="width: 100%; margin-top: 30px; background: #95a5a6;">üóëÔ∏è Limpiar Abono</button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            document.getElementById('listaDeudores').innerHTML = html;
        }

        // MARCAR DEUDA COMO PAGADA
        function marcarComoPagado(cliente) {
            if (confirm(`¬øMarcar todas las deudas de ${cliente} como pagadas?`)) {
                let ventas = obtenerVentas();
                ventas.forEach(v => {
                    if (v.cliente === cliente && v.estado === 'deuda') {
                        v.estado = 'pagado';
                    }
                });
                guardarVentas(ventas);
                
                // Limpiar abonos del cliente
                let abonos = obtenerAbonos();
                delete abonos[cliente];
                guardarAbonos(abonos);
                
                actualizarDeudores();
                actualizarEstadisticas();
                mostrarAlerta(null, `‚úì Deudas de ${cliente} marcadas como pagadas`, 'success');
            }
        }

        // REGISTRAR ABONO PARCIAL
        function registrarAbono(cliente) {
            const inputAbono = document.getElementById(`abono_${cliente}`);
            const montoAbono = parseFloat(inputAbono.value);

            if (!montoAbono || montoAbono <= 0) {
                mostrarAlerta(null, 'Ingresa un monto v√°lido', 'error');
                return;
            }

            // Obtener deuda total del cliente
            const ventas = obtenerVentas();
            let totalDeuda = 0;
            ventas.forEach(v => {
                if (v.cliente === cliente && v.estado === 'deuda') {
                    totalDeuda += v.total;
                }
            });

            // Obtener abonos anteriores
            let abonos = obtenerAbonos();
            const abonoAnterior = abonos[cliente] || 0;
            const nuevoAbono = abonoAnterior + montoAbono;

            if (nuevoAbono > totalDeuda) {
                mostrarAlerta(null, `El abono no puede exceder la deuda total de $${totalDeuda.toFixed(2)}`, 'error');
                return;
            }

            abonos[cliente] = nuevoAbono;
            guardarAbonos(abonos);
            
            inputAbono.value = '';
            actualizarDeudores();
            actualizarEstadisticas();
            mostrarAlerta(null, `‚úì Abono registrado: $${montoAbono.toFixed(2)}`, 'success');
        }

        // LIMPIAR ABONO
        function limpiarAbono(cliente) {
            if (confirm(`¬øLimpiar el abono registrado de ${cliente}?`)) {
                let abonos = obtenerAbonos();
                delete abonos[cliente];
                guardarAbonos(abonos);
                actualizarDeudores();
                mostrarAlerta(null, `‚úì Abono eliminado`, 'success');
            }
        }

        // EXPORTAR VENTAS A EXCEL
        function exportarVentas() {
            const ventas = obtenerVentas();
            if (ventas.length === 0) {
                mostrarAlerta(null, 'No hay ventas para exportar', 'error');
                return;
            }

            let csv = 'Fecha,Hora,Cliente,Total,Estado\n';
            ventas.forEach(venta => {
                csv += `${venta.fecha},${venta.hora},"${venta.cliente}",${venta.total.toFixed(2)},${venta.estado}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ventas_${new Date().toLocaleDateString('es-AR')}.csv`;
            a.click();
        }

        // LIMPIAR TODAS LAS VENTAS
        function limpiarVentas() {
            if (confirm('¬øEst√°s seguro de eliminar TODAS las ventas? Esto no se puede deshacer.')) {
                guardarVentas([]);
                actualizarRegistroVentas();
                mostrarAlerta('alertaVentas', '‚úì Todas las ventas han sido eliminadas', 'success');
            }
        }

        // LIMPIAR FORMULARIO
        function limpiarFormulario() {
            document.getElementById('marca').value = '';
            document.getElementById('tipoVehiculo').value = '';
            document.getElementById('modelo').value = '';
            document.getElementById('amperios').value = '';
            document.getElementById('cantidad').value = '';
            document.getElementById('precio').value = '';
        }

        // MOSTRAR ALERTA
        function mostrarAlerta(elementId, mensaje, tipo) {
            if (!elementId) return;
            const alertaDiv = document.getElementById(elementId);
            alertaDiv.innerHTML = `<div class="alert alert-${tipo}">${mensaje}</div>`;
            setTimeout(() => {
                alertaDiv.innerHTML = '';
            }, 4000);
        }

        // INICIALIZAR AL CARGAR
        window.addEventListener('load', () => {
            inicializarStorage();
            if (!localStorage.getItem('abonos')) {
                localStorage.setItem('abonos', JSON.stringify({}));
            }
            actualizarInventario();
            actualizarSelectProductos();
        });
    </script>
</body>
</html>
